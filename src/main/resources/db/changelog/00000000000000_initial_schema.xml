<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd
                        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

    <property name="now" value="now()" dbms="h2"/>
    <property name="now" value="current_timestamp" dbms="postgresql"/>

    <changeSet id="00000000000000" author="pawel">
        <createSequence sequenceName="hibernate_sequence" startValue="1000" incrementBy="50"/>
    </changeSet>

    <changeSet id="00000000000001" author="pawel">

        <createTable tableName="jhi_persistent_audit_event">
            <column name="event_id" type="bigint" autoIncrement="${autoIncrement}">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="principal" type="varchar(50)">
                <constraints nullable="false" />
            </column>
            <column name="event_date" type="timestamp"/>
            <column name="event_type" type="varchar(255)"/>
        </createTable>

        <createTable tableName="jhi_persistent_audit_evt_data">
            <column name="event_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="varchar(150)">
                <constraints nullable="false"/>
            </column>
            <column name="value" type="varchar(255)"/>
        </createTable>
        <addPrimaryKey columnNames="event_id, name" tableName="jhi_persistent_audit_evt_data"/>

        <createIndex indexName="idx_persistent_audit_event"
                     tableName="jhi_persistent_audit_event"
                     unique="false">
            <column name="principal" type="varchar(50)"/>
            <column name="event_date" type="timestamp"/>
        </createIndex>

        <createIndex indexName="idx_persistent_audit_evt_data"
                     tableName="jhi_persistent_audit_evt_data"
                     unique="false">
            <column name="event_id" type="bigint"/>
        </createIndex>

        <addForeignKeyConstraint baseColumnNames="event_id"
                                 baseTableName="jhi_persistent_audit_evt_data"
                                 constraintName="fk_evt_pers_audit_evt_data"
                                 referencedColumnNames="event_id"
                                 referencedTableName="jhi_persistent_audit_event"/>
    </changeSet>

    <changeSet id="00000000000002" author="pawel" dbms="h2">
        <sql>
            DROP TABLE  BATCH_STEP_EXECUTION_CONTEXT IF EXISTS;
            DROP TABLE  BATCH_JOB_EXECUTION_CONTEXT IF EXISTS;
            DROP TABLE  BATCH_STEP_EXECUTION IF EXISTS;
            DROP TABLE  BATCH_JOB_EXECUTION_PARAMS IF EXISTS;
            DROP TABLE  BATCH_JOB_EXECUTION IF EXISTS;
            DROP TABLE  BATCH_JOB_INSTANCE IF EXISTS;

            DROP SEQUENCE  BATCH_STEP_EXECUTION_SEQ IF EXISTS;
            DROP SEQUENCE  BATCH_JOB_EXECUTION_SEQ IF EXISTS;
            DROP SEQUENCE  BATCH_JOB_SEQ IF EXISTS;
            -- Autogenerated: do not edit this file

            CREATE TABLE BATCH_JOB_INSTANCE  (
            JOB_INSTANCE_ID BIGINT IDENTITY NOT NULL PRIMARY KEY ,
            VERSION BIGINT ,
            JOB_NAME VARCHAR(100) NOT NULL,
            JOB_KEY VARCHAR(32) NOT NULL,
            constraint JOB_INST_UN unique (JOB_NAME, JOB_KEY)
            ) ;

            CREATE TABLE BATCH_JOB_EXECUTION  (
            JOB_EXECUTION_ID BIGINT IDENTITY NOT NULL PRIMARY KEY ,
            VERSION BIGINT  ,
            JOB_INSTANCE_ID BIGINT NOT NULL,
            CREATE_TIME TIMESTAMP NOT NULL,
            START_TIME TIMESTAMP DEFAULT NULL ,
            END_TIME TIMESTAMP DEFAULT NULL ,
            STATUS VARCHAR(10) ,
            EXIT_CODE VARCHAR(2500) ,
            EXIT_MESSAGE VARCHAR(2500) ,
            LAST_UPDATED TIMESTAMP,
            JOB_CONFIGURATION_LOCATION VARCHAR(2500) NULL,
            constraint JOB_INST_EXEC_FK foreign key (JOB_INSTANCE_ID)
            references BATCH_JOB_INSTANCE(JOB_INSTANCE_ID)
            ) ;

            CREATE TABLE BATCH_JOB_EXECUTION_PARAMS  (
            JOB_EXECUTION_ID BIGINT NOT NULL ,
            TYPE_CD VARCHAR(6) NOT NULL ,
            KEY_NAME VARCHAR(100) NOT NULL ,
            STRING_VAL VARCHAR(250) ,
            DATE_VAL TIMESTAMP DEFAULT NULL ,
            LONG_VAL BIGINT ,
            DOUBLE_VAL DOUBLE PRECISION ,
            IDENTIFYING CHAR(1) NOT NULL ,
            constraint JOB_EXEC_PARAMS_FK foreign key (JOB_EXECUTION_ID)
            references BATCH_JOB_EXECUTION(JOB_EXECUTION_ID)
            ) ;

            CREATE TABLE BATCH_STEP_EXECUTION  (
            STEP_EXECUTION_ID BIGINT IDENTITY NOT NULL PRIMARY KEY ,
            VERSION BIGINT NOT NULL,
            STEP_NAME VARCHAR(100) NOT NULL,
            JOB_EXECUTION_ID BIGINT NOT NULL,
            START_TIME TIMESTAMP NOT NULL ,
            END_TIME TIMESTAMP DEFAULT NULL ,
            STATUS VARCHAR(10) ,
            COMMIT_COUNT BIGINT ,
            READ_COUNT BIGINT ,
            FILTER_COUNT BIGINT ,
            WRITE_COUNT BIGINT ,
            READ_SKIP_COUNT BIGINT ,
            WRITE_SKIP_COUNT BIGINT ,
            PROCESS_SKIP_COUNT BIGINT ,
            ROLLBACK_COUNT BIGINT ,
            EXIT_CODE VARCHAR(2500) ,
            EXIT_MESSAGE VARCHAR(2500) ,
            LAST_UPDATED TIMESTAMP,
            constraint JOB_EXEC_STEP_FK foreign key (JOB_EXECUTION_ID)
            references BATCH_JOB_EXECUTION(JOB_EXECUTION_ID)
            ) ;

            CREATE TABLE BATCH_STEP_EXECUTION_CONTEXT  (
            STEP_EXECUTION_ID BIGINT NOT NULL PRIMARY KEY,
            SHORT_CONTEXT VARCHAR(2500) NOT NULL,
            SERIALIZED_CONTEXT LONGVARCHAR ,
            constraint STEP_EXEC_CTX_FK foreign key (STEP_EXECUTION_ID)
            references BATCH_STEP_EXECUTION(STEP_EXECUTION_ID)
            ) ;

            CREATE TABLE BATCH_JOB_EXECUTION_CONTEXT  (
            JOB_EXECUTION_ID BIGINT NOT NULL PRIMARY KEY,
            SHORT_CONTEXT VARCHAR(2500) NOT NULL,
            SERIALIZED_CONTEXT LONGVARCHAR ,
            constraint JOB_EXEC_CTX_FK foreign key (JOB_EXECUTION_ID)
            references BATCH_JOB_EXECUTION(JOB_EXECUTION_ID)
            ) ;

            CREATE SEQUENCE BATCH_STEP_EXECUTION_SEQ;
            CREATE SEQUENCE BATCH_JOB_EXECUTION_SEQ;
            CREATE SEQUENCE BATCH_JOB_SEQ;

        </sql>
    </changeSet>


    <changeSet id="00000000000003" author="pawel" dbms="postgresql">
        <sql>
            -- Autogenerated: do not edit this file
            DROP TABLE  IF EXISTS BATCH_STEP_EXECUTION_CONTEXT;
            DROP TABLE  IF EXISTS BATCH_JOB_EXECUTION_CONTEXT;
            DROP TABLE  IF EXISTS BATCH_STEP_EXECUTION;
            DROP TABLE  IF EXISTS BATCH_JOB_EXECUTION_PARAMS;
            DROP TABLE  IF EXISTS BATCH_JOB_EXECUTION;
            DROP TABLE  IF EXISTS BATCH_JOB_INSTANCE;

            DROP SEQUENCE  IF EXISTS BATCH_STEP_EXECUTION_SEQ ;
            DROP SEQUENCE  IF EXISTS BATCH_JOB_EXECUTION_SEQ ;
            DROP SEQUENCE  IF EXISTS BATCH_JOB_SEQ ;

            -- Autogenerated: do not edit this file

            CREATE TABLE BATCH_JOB_INSTANCE  (
            JOB_INSTANCE_ID BIGINT  NOT NULL PRIMARY KEY ,
            VERSION BIGINT ,
            JOB_NAME VARCHAR(100) NOT NULL,
            JOB_KEY VARCHAR(32) NOT NULL,
            constraint JOB_INST_UN unique (JOB_NAME, JOB_KEY)
            ) ;

            CREATE TABLE BATCH_JOB_EXECUTION  (
            JOB_EXECUTION_ID BIGINT  NOT NULL PRIMARY KEY ,
            VERSION BIGINT  ,
            JOB_INSTANCE_ID BIGINT NOT NULL,
            CREATE_TIME TIMESTAMP NOT NULL,
            START_TIME TIMESTAMP DEFAULT NULL ,
            END_TIME TIMESTAMP DEFAULT NULL ,
            STATUS VARCHAR(10) ,
            EXIT_CODE VARCHAR(2500) ,
            EXIT_MESSAGE VARCHAR(2500) ,
            LAST_UPDATED TIMESTAMP,
            JOB_CONFIGURATION_LOCATION VARCHAR(2500) NULL,
            constraint JOB_INST_EXEC_FK foreign key (JOB_INSTANCE_ID)
            references BATCH_JOB_INSTANCE(JOB_INSTANCE_ID)
            ) ;

            CREATE TABLE BATCH_JOB_EXECUTION_PARAMS  (
            JOB_EXECUTION_ID BIGINT NOT NULL ,
            TYPE_CD VARCHAR(6) NOT NULL ,
            KEY_NAME VARCHAR(100) NOT NULL ,
            STRING_VAL VARCHAR(250) ,
            DATE_VAL TIMESTAMP DEFAULT NULL ,
            LONG_VAL BIGINT ,
            DOUBLE_VAL DOUBLE PRECISION ,
            IDENTIFYING CHAR(1) NOT NULL ,
            constraint JOB_EXEC_PARAMS_FK foreign key (JOB_EXECUTION_ID)
            references BATCH_JOB_EXECUTION(JOB_EXECUTION_ID)
            ) ;

            CREATE TABLE BATCH_STEP_EXECUTION  (
            STEP_EXECUTION_ID BIGINT  NOT NULL PRIMARY KEY ,
            VERSION BIGINT NOT NULL,
            STEP_NAME VARCHAR(100) NOT NULL,
            JOB_EXECUTION_ID BIGINT NOT NULL,
            START_TIME TIMESTAMP NOT NULL ,
            END_TIME TIMESTAMP DEFAULT NULL ,
            STATUS VARCHAR(10) ,
            COMMIT_COUNT BIGINT ,
            READ_COUNT BIGINT ,
            FILTER_COUNT BIGINT ,
            WRITE_COUNT BIGINT ,
            READ_SKIP_COUNT BIGINT ,
            WRITE_SKIP_COUNT BIGINT ,
            PROCESS_SKIP_COUNT BIGINT ,
            ROLLBACK_COUNT BIGINT ,
            EXIT_CODE VARCHAR(2500) ,
            EXIT_MESSAGE VARCHAR(2500) ,
            LAST_UPDATED TIMESTAMP,
            constraint JOB_EXEC_STEP_FK foreign key (JOB_EXECUTION_ID)
            references BATCH_JOB_EXECUTION(JOB_EXECUTION_ID)
            ) ;

            CREATE TABLE BATCH_STEP_EXECUTION_CONTEXT  (
            STEP_EXECUTION_ID BIGINT NOT NULL PRIMARY KEY,
            SHORT_CONTEXT VARCHAR(2500) NOT NULL,
            SERIALIZED_CONTEXT TEXT ,
            constraint STEP_EXEC_CTX_FK foreign key (STEP_EXECUTION_ID)
            references BATCH_STEP_EXECUTION(STEP_EXECUTION_ID)
            ) ;

            CREATE TABLE BATCH_JOB_EXECUTION_CONTEXT  (
            JOB_EXECUTION_ID BIGINT NOT NULL PRIMARY KEY,
            SHORT_CONTEXT VARCHAR(2500) NOT NULL,
            SERIALIZED_CONTEXT TEXT ,
            constraint JOB_EXEC_CTX_FK foreign key (JOB_EXECUTION_ID)
            references BATCH_JOB_EXECUTION(JOB_EXECUTION_ID)
            ) ;

            CREATE SEQUENCE BATCH_STEP_EXECUTION_SEQ MAXVALUE 9223372036854775807 NO CYCLE;
            CREATE SEQUENCE BATCH_JOB_EXECUTION_SEQ MAXVALUE 9223372036854775807 NO CYCLE;
            CREATE SEQUENCE BATCH_JOB_SEQ MAXVALUE 9223372036854775807 NO CYCLE;


        </sql>
    </changeSet>

    <changeSet  author="yogesh(manual)"  id="20220318-1">
        <renameColumn  columnDataType="varchar(255)"
                       newColumnName="audit_data"
                       oldColumnName="value"
                       remarks="Value is now a reserved word."
                       tableName="jhi_persistent_audit_evt_data"/>
    </changeSet>

</databaseChangeLog>
